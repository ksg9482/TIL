# URL을 입력하면 벌어지는 일

## URL 파싱
입력된 URL을 분해해서 어떤 프로토콜로 어떤 도메인으로 보낼까 결정한다.   
https:\/\/www.example.com:443
위 URL을 분해하면 https 프로토콜로, example 도메인에, 443 포트를 통해 응답을 요청한다는 뜻이다. 포트의 경우에는 직접 입력하지 않아도 종류에 맞게 자동으로 설정된다.  

## 브라우저가 IP 주소를 찾기 위해 캐시에서 DNS 기록을 확인한다.
DNS는 웹사이트의 IP주소와 도메인 주소를 연결해주는 시스템이다. 모든 URL에는 고유한 IP주소가 할당되어 있으며, IP주소는 서버를 호스트하는 컴퓨터에 속한다. 가령 www.google.com의 IP주소는 142.250.196.110이기 때문에 브라우저에서 https:\/\/142.250.196.110 를 입력하여 www.google.com에 접속할 수 있다


#### DNS 기록을 찾기 위해 브라우저는 4개의 캐시를 확인한다.
* 브라우저 캐시 확인. 브라우저는 이전에 방문한 웹사이트의 DNS 기록을 일정 시간 동안 저장하고 있다.
* OS 캐시 확인. 브라우저 캐시에 원하는 DNS 기록이 없다면 컴퓨터 OS에 시스템 호출을 통해 OS에 저장된 DNS 기록을 가져온다.
* 라우터 캐시 확인. 컴퓨터 OS에도 원하는 DNS 기록이 없다면 라우터에서 DNS 기록을 저장한 캐시를 확인한다.
* ISP(Internet Service Provider) 확인. 위 모든 단계에서 DNS 기록을 찾지 못했다면 브라우저는 ISP에서 DNS 기록을 찾는다. ISP는 DNS 서버를 가지고 있는데, 해당 서버에서 DNS 기록 캐시를 검색 할 수 있다.
  * DNS 서버는 할당된 도메인 영역에 대한 정보를 가지고 있는 서버로, 주로 도메인을 IP주소로 변환하는 역할을 한다.

## 만약 요청한 URL이 캐시에 없다면, ISP의 DNS 서버가 DNS 쿼리로 해당 URL을 호스팅하는 서버의 IP 주소를 찾는다.
DNS 쿼리란 웹사이트에 대한 올바른 IP 주소를 찾을 때까지 인터넷에서 여러 DNS 서버를 검색하는 것이다. 원하는 IP주소를 찾거나 오류 응답을 반환 할 때까지 한 DNS 서버에서 다른 DNS 서버로 검색을 반복한다.
* ISP의 DNS 서버와 다른 DNS 서버는 어떻게 다를까?
  * ISP의 DNS 서버는 인터넷의 다른 DNS 서버에 답변을 요청하여 의도된 도메인 이름의 적절한 IP 주소를 찾는 일을 담당한다. ISP의 DNS 서버를 DNS 리커서(DNS Recursor)라고 부른다.
  * 다른 DNS 서버는 웹사이트 도메인 이름의 도메인 아키텍처를 기반으로 DNS 검색을 수행한다. 이런 DNS 서버를 네임 서버(Name Server)라고 부른다.

오늘날 많은 웹사이트 URL은 3차 도메인, 2차 도메인 및 최상위 도메인(TLD: Top Level Domain)으로 이뤄진다. 각 단계에는 DNS 룩업(lookup) 도중에 쿼리되는 고유한 네임 서버가 있다.
* DNS Lookup
  * DNS 서버에서 인터넷 도메인 이름을 사용해 인터넷 주소 (ip)를 알아내는 과정을 말한다.
    
#### 예를 들어 google.com에 연결하는 방법
* DNS 리커서가 루트 네임 서버(Root Name Server)에 연결한다.
* 루트 네임 서버는 리커서를 .com 도메인 네임 서버로 리디렉션한다.
* .com 네임 서버는 google.com 네임 서버로 리디렉션한다.
* google.com 네임 서버는 DNS 기록에서 google.com과 일치하는 IP 주소를 찾아 DNS 리커서로 반환한다.
* 리커서는 이를 브라우저로 보낸다.

위와 같은 요청은 정보를 작은 데이터 패킷에 담겨 전송된다. 패킷은 올바른 DNS 서버에 도달하기 전에 클라이언트와 서버 사이의 여어 네트워킹 장비를 통해 이동한다. 이 장비는 라우팅 테이블을 사용하여 패킷이 목적지에 도달 할 수 있는 가장 빠른 방법을 알아낸다. 만약 이동 도중 패킷이 손실되면 요청 실패 오류가 발생하고, 정상적으로 처리된다면 올바른 DNS 서버에 도달하여 IP 주소를 가져온 후 브라우저로 돌아간다.

## 브라우저가 해당 서버와 TCP 연결을 시작한다.
브라우저가 올바른 IP 주소를 수신하면 IP 주소와 일치하는 서버와 연결해 정보를 전송한다. 일반적으로 http요청에서는 TCP(Transmission Control Protocol)라는 전송 제어 프로토콜을 사용한다.

대상 서버와 연결은 TCP/IP 3-way handshake라는 연결 과정을 통해 이뤄지는데, 이는 클라이언트와 서버가 'SYN(연결 요청: synchronize)'과 'ACK(승인: acknowledgement)'메시지를 교환하여 연결을 설정하는 3단계 프로세스이다.
* 클라이언트가 서버에 SYN 패킷을 보내 새 연결이 가능한지 여부를 묻는다.
* 서버에 새 연결을 수락할 수 있는 열린 포트가 있는 경우, SYN/ACK 패킷을 사용하여 SYN 패킷의 ACK(승인)으로 응답한다.
* 클라이언트는 서버로부터 SYN/ACK 패킷을 수신하고 ACK 패킷을 전송하여 승인한다.

https의 경우 TLS handshaking이 추가된다.

## 브라우저가 웹서버에 HTTP 요청을 보낸다.
TCP 연결이 설정되면 데이터 전송이 시작되고, 브라우저는 웹 페이지를 요청하는 GET 요청을 보낸다. 만약 자격 증명(credentials)을 입력하거나 form을 제출하는 경우 POST 요청을 사용할 수 있다. 이 요청에는 브라우저 식별(User-Agent 헤더), 수락할 요청 유형(Accept 헤더) 및 추가 요청을 위해 TCP 연결을 유지하라는 연결 헤더와 같은 추가 정보, 브라우저가 도메인에 대해 저장한 쿠키에서 가져온 정보도 포함된다.

## 서버가 요청을 처리하고 응답을 보낸다.
서버에는 웹서버가 포함되어 있는데, 이는 브라우저로부터 요청을 수신하고, 해당 내용을 request handler에 전달하여 응답을 읽고 생성하는 역할을 한다.
* Request handler
  * 요청을 읽고 필요한 경우 서버의 정보를 업데이트하는 프로그램이다.
Request handler에서 처리가 끝나면 response를 특정 포맷으로(JSON, XML, HTML)으로 작성한다.

## 서버가 HTTP 응답을 보낸다.
서버 응답에는 요청한 웹 페이지와 함께 상태 코드(status code), 압축 유형(Content-Encoding), 페이지 캐싱 방법(Cache-Control), 설정할 쿠키, 개인 정보 등이 포함 된다.

## 브라우저가 HTML 컨텐츠를 보여준다.
브라우저는 응답받은 HTML을 화면에 단계별로 표시한다. 
* HTML 골격을 렌더링한다.
* HTML 태그를 확인하고 이미지, CSS 스타일시트, 자바스크립트 파일 등과 같은 웹 페이지의 추가 요소에 대한 GET 요청을 보낸다. 
  * 정적 파일(Static File)은 브라우저에서 캐싱되므로 다음에 페이지를 방문할 때 다시 가져올 필요가 없다.
* 페이지가 브라우저에 나타난다.


### 참고사항
#### HSTS 목록 조회
HSTS(HTTP Strict Transport Security)는 http 연결은 허가하지 않고 https 연결만 허용한다. 만약 http 연결이 들어오면 HSTS 목록에 해당 URL이 있을 경우 명시적으로 http로 요청해도 https로 요청을 보낸다. HSTS 목록이란 http 연결이 들어왔을 때 Strict Transport Security 필드를 응답 헤더에 포함해서 보내고 이를 확인한 브라우저는 https만을 통해 통신한다. 그리고는 자신의 HSTS 캐시에 해당 URL을 저장하는데 이 캐시를 HSTS 목록이라고 한다. 이 HSTS 목록은 브라우저가 가지고 있다.

#### URL을 IP로 변환
google.com 이런 형식의 주소로는 컴퓨터끼리 통신이 불가능하다. DNS서버에 요청하여 해당 URL을 IP주소로 변환한다.

#### IP주소를 MAC주소로 변환
실질적인 통신을 위해서는 IP주소를 ARP를 통해 MAC주소로 변환해야 한다. 해당 네트워크에서 ARP를 브로드캐스트하면 해당 IP주소를 가지는 노드는 자신의 MAC주소를 응답한다.

##### IP주소와 MAC주소
* IP
  * 호스트나 라우터 장비의 인터페이스에 할당된 주소이다.
  * 유동적이다.
* MAC
  * NIC(Network Interface Card)에 할당된 고유 식별 주소이다.
  * 유동적이지 않은 고유 주소이다.



